# 客户归属管理页面功能说明

## 页面路径
`/crm/customerassign/assignment`

## 功能概述

客户归属管理页面提供了完整的客户分配、认领和回收功能，支持单个操作和批量操作。

## 功能列表

### 1. 批量操作（工具栏按钮）

#### 1.1 批量分配
- **按钮**: 批量分配（主要按钮，蓝色）
- **图标**: 添加图标
- **功能**: 为选中的客户批量分配管理者
- **权限**: `aicrm:customer-assignment:create`
- **流程**:
  1. 勾选需要分配的客户（可多选）
  2. 点击"批量分配"按钮
  3. 在弹出的对话框中选择：
     - 归属类型（主办/协办）
     - 归属部门
     - 客户经理
     - 分配备注（可选）
  4. 确认后完成分配

**特点**:
- 支持为已分配的客户再次分配（添加协办）
- 如果分配主办，会自动将原主办转为协办
- 可以同时为多个客户分配

#### 1.2 批量认领
- **按钮**: 批量认领（次要按钮，默认样式）
- **图标**: 下载图标
- **功能**: 快速认领多个未分配的客户到当前用户
- **权限**: `aicrm:customer-assignment:create`
- **流程**:
  1. 勾选需要认领的客户（可多选）
  2. 点击"批量认领"按钮
  3. 系统自动过滤：
     - 只保留未分配的客户（`assignmentStatus = 0`）
     - 如有已分配客户，会提示过滤数量
  4. 确认对话框显示实际可认领数量
  5. 确认后完成认领

**特点**:
- 只能认领未分配的客户
- 自动使用当前用户作为主办
- 自动使用当前用户的部门作为归属部门
- 智能过滤：即使选中了已分配客户，也会自动过滤掉
- 提示信息：告知用户过滤了多少已分配客户

**示例提示**:
- 全部可认领: "确定要认领 5 个客户吗？"
- 部分可认领: "只能认领未分配的客户，已自动过滤 3 个已分配的客户"

#### 1.3 批量回收
- **按钮**: 批量回收（次要按钮，默认样式）
- **图标**: 删除图标
- **功能**: 批量回收已分配客户的所有归属关系
- **权限**: `aicrm:customer-assignment:delete`
- **流程**:
  1. 勾选需要回收的客户（可多选）
  2. 点击"批量回收"按钮
  3. 系统自动过滤：
     - 只保留已分配的客户（`assignmentStatus = 1`）
     - 如有未分配客户，会提示过滤数量
  4. 确认对话框显示实际可回收数量
  5. 确认后完成回收

**特点**:
- 只能回收已分配的客户
- 回收后客户状态变为未分配
- 删除所有归属关系（包括主办和协办）
- 智能过滤：即使选中了未分配客户，也会自动过滤掉
- 提示信息：告知用户过滤了多少未分配客户

**示例提示**:
- 全部可回收: "确定要回收 5 个客户吗？"
- 部分可回收: "只能回收已分配的客户，已自动过滤 2 个未分配的客户"

### 2. 单个操作（行内按钮）

每个客户行都有以下操作按钮：

#### 2.1 查看
- **按钮**: 查看（链接按钮）
- **功能**: 查看客户的所有归属关系
- **显示条件**: 始终显示
- **对话框内容**:
  - 客户基本信息
  - 归属关系列表（主办、协办）
  - 归属类型、部门、客户经理、分配日期、备注等

#### 2.2 分配
- **按钮**: 分配（链接按钮）
- **功能**: 为单个客户分配管理者
- **显示条件**: 始终显示
- **说明**: 可以为已分配客户再次分配（添加协办）

#### 2.3 认领
- **按钮**: 认领（链接按钮）
- **功能**: 快速认领该客户到当前用户
- **显示条件**: 仅当 `assignmentStatus = 0`（未分配）时显示
- **流程**:
  1. 点击"认领"按钮
  2. 如果客户已分配，提示"只能认领未分配的客户"
  3. 如果当前用户未设置部门，提示错误
  4. 确认对话框显示客户名称
  5. 确认后完成认领

#### 2.4 回收
- **按钮**: 回收（链接按钮，红色/危险样式）
- **功能**: 回收该客户的所有归属关系
- **显示条件**: 仅当 `assignmentStatus = 1`（已分配）时显示
- **流程**:
  1. 点击"回收"按钮
  2. 如果客户未分配，提示"该客户未分配，无需回收"
  3. 确认对话框显示客户名称
  4. 确认后完成回收

## 技术实现

### 状态管理
- 使用 `useUserStore` 获取当前登录用户信息
- 使用 `gridApi.grid.getCheckboxRecords()` 获取选中的客户行

### 智能过滤
批量认领和批量回收都实现了智能过滤功能：

```typescript
// 批量认领：过滤未分配客户
const unassignedRows = selectedRows.filter(
  (row) => row.assignmentStatus === 0
);

// 批量回收：过滤已分配客户
const assignedRows = selectedRows.filter(
  (row) => row.assignmentStatus === 1
);
```

### API 调用
- **分配**: `assignCustomers()`
- **回收**: `reclaimCustomers()`

### 刷新机制
所有操作成功后都会调用 `handleRefresh()` 刷新表格数据。

## 用户体验优化

### 1. 智能提示
- 未选择客户时提示选择
- 所选客户状态不符时自动过滤并提示
- 操作成功后显示具体数量

### 2. 状态校验
- 认领前检查客户分配状态
- 认领前检查用户部门信息
- 回收前检查客户分配状态

### 3. 确认对话框
- 显示具体操作数量
- 说明操作后果
- 防止误操作

### 4. 按钮显示逻辑
- 认领按钮只在未分配客户显示
- 回收按钮只在已分配客户显示
- 减少用户困惑

## 权限控制

- 批量分配：`aicrm:customer-assignment:create`
- 批量认领：`aicrm:customer-assignment:create`
- 批量回收：`aicrm:customer-assignment:delete`

## 注意事项

1. **认领限制**: 只能认领未分配的客户
2. **回收限制**: 只能回收已分配的客户
3. **部门要求**: 认领功能要求用户必须设置部门
4. **物理删除**: 回收操作使用物理删除，永久删除归属关系
5. **状态同步**: 操作后会自动更新客户的分配状态和部门信息

## 相关文件

- 页面组件: `assignment-manage/index.vue`
- 分配对话框: `assignment-manage/assign-modal.vue`
- 查看对话框: `assignment-manage/view-assignment-modal.vue`
- 表格配置: `assignment-manage/data.ts`
- API 接口: `#/api/aicrm/customerassignment`

## 更新日志

- **2025-11-03**: 添加批量分配、批量认领、批量回收功能
- **2025-11-03**: 实现智能状态过滤和用户提示
- **2025-11-03**: 优化认领和回收按钮的显示逻辑
