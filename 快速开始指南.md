# 客户管理关系模块 - 快速开始指南

> 10 分钟快速部署和体验客户管理关系模块

## 一、前置检查 ✅

确保你的环境满足以下要求：

```bash
# 检查 JDK 版本（需要 17 或 21）
java -version

# 检查 Node.js 版本（需要 >= 20.10.0）
node -v

# 检查 pnpm 版本（需要 >= 10.14.0）
pnpm -v

# 检查 MySQL 是否运行（需要 8.0+）
mysql --version

# 检查 Redis 是否运行（需要 6.0+）
redis-cli ping
```

**如果有任何版本不符合，请先升级！**

---

## 二、快速部署（5 分钟）⚡

### 步骤 1: 初始化数据库（2 分钟）

```bash
# 进入 SQL 脚本目录
cd backend/sql/mysql

# 执行 3 个初始化脚本
mysql -u root -p ruoyi-vue-pro < crm_customer_management_relationship.sql
mysql -u root -p ruoyi-vue-pro < crm_customer_management_relationship_dict.sql
mysql -u root -p ruoyi-vue-pro < crm_customer_management_relationship_menu.sql
```

**注意**: 如果提示输入密码,请输入你的 MySQL root 密码。

### 步骤 2: 启动后端服务（2 分钟）

```bash
# 进入后端目录
cd backend

# 清理并编译（第一次需要）
mvn clean compile

# 启动服务
cd yudao-server
mvn spring-boot:run -Dspring-boot.run.profiles=local
```

等待看到 `Started YudaoServerApplication` 日志,后端启动成功！

**验证**: 访问 http://localhost:48080/doc.html 看到 API 文档页面

### 步骤 3: 启动前端服务（1 分钟）

```bash
# 新开一个终端窗口
cd frontend

# 安装依赖（如果尚未安装）
pnpm install

# 启动前端
pnpm dev:antd
```

等待看到 `ready in xxx ms` 消息,前端启动成功！

**验证**: 访问 http://localhost:5666

---

## 三、快速体验（5 分钟）🚀

### 3.1 登录系统

1. 打开浏览器访问: http://localhost:5666
2. 输入账号密码:
   - 用户名: `admin`
   - 密码: `admin123`
3. 点击登录

### 3.2 查看新菜单

登录成功后,在左侧菜单栏找到:
- 📋 **客户托管记录**
- ➕ **客户认领申请**
- ⏮️ **客户退回申请**
- 📊 **客户归属关系管理** (已增强,包含批量操作)

### 3.3 测试客户托管功能

#### 第一步: 准备测试数据

```sql
-- 在 MySQL 中执行以下 SQL 创建测试客户
INSERT INTO crm_customer (customer_no, customer_type, customer_name, customer_status, dept_id, creator, create_time)
VALUES ('TEST001', 1, '测试客户001', 1, 103, 'admin', NOW());

-- 获取客户 ID（记住这个 ID）
SELECT id, customer_no, customer_name FROM crm_customer WHERE customer_no = 'TEST001';

-- 为测试客户创建归属关系
INSERT INTO crm_customer_assignment (customer_id, assignment_type, dept_id, user_id, has_view_right, has_maintain_right, assign_date, effective_date, assign_operator_id, status, creator, create_time)
VALUES (
    (SELECT id FROM crm_customer WHERE customer_no = 'TEST001'),  -- customer_id
    1,          -- assignment_type (1=主办)
    103,        -- dept_id
    1,          -- user_id (admin用户ID)
    1,          -- has_view_right
    1,          -- has_maintain_right
    CURDATE(),  -- assign_date
    CURDATE(),  -- effective_date
    1,          -- assign_operator_id
    1,          -- status (1=生效中)
    'admin',    -- creator
    NOW()       -- create_time
);
```

#### 第二步: 创建托管

1. 进入 **客户托管记录** 页面
2. 点击 **创建托管** 按钮
3. 填写表单:
   ```
   客户ID: <刚才记下的客户ID>
   受托方客户经理ID: 104  (系统中其他用户的ID)
   托管开始日期: <选择今天>
   托管结束日期: <选择30天后>
   托管原因: 测试客户托管功能
   ```
4. 点击 **创建** 按钮
5. ✅ 看到成功提示: "创建托管成功"

#### 第三步: 验证托管结果

1. 在 **客户托管记录** 列表中看到新创建的记录
2. 托管状态显示为 **托管中**
3. 进入 **客户归属关系管理** 页面
4. 找到该客户的归属关系,看到 `user_id` 已更新为受托方ID

#### 第四步: 结束托管

1. 回到 **客户托管记录** 页面
2. 找到刚才创建的托管记录
3. 点击 **结束托管** 按钮
4. 填写结束原因: "测试完成"
5. 点击 **结束** 按钮
6. ✅ 托管状态更新为 **已结束**

### 3.4 测试批量操作功能

#### 第一步: 准备多个测试客户

```sql
-- 创建 3 个测试客户并分配归属关系
INSERT INTO crm_customer (customer_no, customer_type, customer_name, customer_status, dept_id, creator, create_time)
VALUES
('TEST002', 1, '测试客户002', 1, 103, 'admin', NOW()),
('TEST003', 1, '测试客户003', 1, 103, 'admin', NOW()),
('TEST004', 1, '测试客户004', 1, 103, 'admin', NOW());

-- 为这 3 个客户创建归属关系
INSERT INTO crm_customer_assignment (customer_id, assignment_type, dept_id, user_id, has_view_right, has_maintain_right, assign_date, effective_date, assign_operator_id, status, creator, create_time)
SELECT
    id as customer_id,
    1 as assignment_type,
    103 as dept_id,
    1 as user_id,
    1 as has_view_right,
    1 as has_maintain_right,
    CURDATE() as assign_date,
    CURDATE() as effective_date,
    1 as assign_operator_id,
    1 as status,
    'admin' as creator,
    NOW() as create_time
FROM crm_customer
WHERE customer_no IN ('TEST002', 'TEST003', 'TEST004');
```

#### 第二步: 批量移交

1. 进入 **客户归属关系管理** 页面
2. 勾选刚才创建的 3 个客户的归属关系记录
3. 点击工具栏的 **批量移交** 按钮
4. 填写表单:
   ```
   目标客户经理ID: 104
   移交原因: 批量操作测试
   ```
5. 点击 **提交** 按钮
6. ✅ 看到成功提示: "批量移交客户成功"

#### 第三步: 验证结果

1. 刷新页面,看到这 3 个客户的归属关系已更新
2. `user_id` 全部变更为 104
3. 进入 **客户管理关系变更历史** 页面
4. 看到 3 条 "客户移交" 的历史记录

---

## 四、配置 BPM 审批流程（可选）🔄

如果要测试**客户认领**和**客户退回**功能,需要先配置 BPM 审批流程。

### 快速配置步骤:

1. 登录系统后台
2. 进入 **工作流管理 -> 流程管理 -> 流程定义**
3. 点击 **新增流程**

#### 配置客户认领审批流程

```yaml
流程标识: crm_customer_claim
流程名称: 客户认领审批
流程分类: 业务流程
流程描述: 客户经理申请认领无主客户的审批流程
```

**简单配置**:
- 使用 **Simple 模式**（仿钉钉）
- 添加 1 个审批节点: "部门主管审批"
- 审批人规则: 选择 "发起人的直属上级"
- 保存并发布流程

#### 配置客户退回审批流程

```yaml
流程标识: crm_customer_return
流程名称: 客户退回审批
流程分类: 业务流程
流程描述: 客户经理申请退回客户给上级的审批流程
```

**简单配置**:
- 使用 **Simple 模式**
- 添加 1 个审批节点: "部门主管审批"
- 审批人规则: 选择 "发起人的直属上级"
- 保存并发布流程

### 测试审批流程:

1. 创建一个普通用户账号（不是 admin）
2. 为该用户配置直属上级
3. 用该用户登录,提交客户认领申请
4. 用上级用户登录,在 **待办任务** 中审批

---

## 五、常见问题快速解决 🔧

### 问题 1: 后端启动失败

**原因**: MySQL 或 Redis 未启动

**解决**:
```bash
# 检查 MySQL
mysql -u root -p -e "SELECT 1"

# 检查 Redis
redis-cli ping

# 如果未启动，使用 Docker 快速启动
cd backend/script/docker
docker-compose up -d mysql redis
```

### 问题 2: 前端看不到新菜单

**原因**: 菜单配置 SQL 未执行或权限未分配

**解决**:
```sql
-- 检查菜单是否已创建
SELECT id, name, component FROM system_menu
WHERE component IN (
    'aicrm/customerdelegation/index',
    'aicrm/customerclaim/index',
    'aicrm/customerreturn/index'
);

-- 如果没有记录，重新执行菜单配置 SQL
source crm_customer_management_relationship_menu.sql;
```

### 问题 3: 批量操作按钮禁用

**原因**: 未选中任何记录

**解决**: 在表格中勾选至少一条记录,批量操作按钮会自动启用

### 问题 4: BPM 审批不工作

**原因**: BPM 模块未启用或流程未配置

**解决**:
1. 确认 `backend/ynet-module-crm/pom.xml` 中 BPM 依赖已启用
2. 重新编译: `mvn clean compile`
3. 检查流程定义的 Key 是否正确:
   - 客户认领: `crm_customer_claim`
   - 客户退回: `crm_customer_return`
4. 确认流程已发布

### 问题 5: 端口冲突

**后端端口冲突（48080）**:
```yaml
# 修改 backend/yudao-server/src/main/resources/application-local.yaml
server:
  port: 48081  # 改为其他端口
```

**前端端口冲突（5666）**:
```bash
# 修改 frontend/apps/web-antd/.env.development
VITE_PORT=5667  # 改为其他端口
```

---

## 六、下一步学习 📚

现在你已经成功部署并体验了客户管理关系模块！

**深入学习**:
1. 📖 阅读 [部署指南](./backend/ynet-module-crm/客户管理关系模块部署指南.md) - 了解详细的配置和使用说明
2. ✅ 查看 [测试用例](./backend/ynet-module-crm/测试用例.md) - 完整的功能测试指南
3. 📊 查看 [开发完成报告](./客户管理关系模块开发完成报告.md) - 了解技术实现细节
4. 🔌 访问 [API 文档](http://localhost:48080/doc.html) - 查看所有 API 接口

**扩展功能**:
- 实现客户池管理
- 添加数据统计分析
- 集成消息通知
- 实现批量导入功能

---

## 七、获取帮助 💬

遇到问题？
1. 查看 [部署指南](./backend/ynet-module-crm/客户管理关系模块部署指南.md) 的"常见问题"章节
2. 查看后端日志: `backend/yudao-server/logs/`
3. 查看浏览器控制台的错误信息（F12）
4. 联系开发团队

---

**祝你使用愉快！** 🎉

*最后更新: 2025-10-31*
