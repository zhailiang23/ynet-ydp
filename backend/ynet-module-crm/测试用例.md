# 客户管理关系模块 - 测试用例

## 一、测试环境准备

### 1.1 测试账号

| 角色 | 账号 | 密码 | 权限 |
|-----|------|------|------|
| 超级管理员 | admin | admin123 | 所有权限 |
| 部门主管 | manager1 | 123456 | 审批权限 |
| 客户经理A | user1 | 123456 | 基本操作权限 |
| 客户经理B | user2 | 123456 | 基本操作权限 |

### 1.2 测试数据

创建测试客户:
```sql
-- 插入测试客户
INSERT INTO crm_customer (customer_no, customer_type, customer_name, customer_status, dept_id, creator, create_time)
VALUES
('TEST001', 1, '测试零售客户001', 1, 100, 'admin', NOW()),
('TEST002', 1, '测试零售客户002', 1, 100, 'admin', NOW()),
('TEST003', 1, '测试零售客户003', 1, 100, 'admin', NOW()),
('TEST004', 2, '测试对公客户001', 1, 100, 'admin', NOW()),
('TEST005', 2, '测试对公客户002', 1, 100, 'admin', NOW());

-- 获取测试客户ID
SELECT id, customer_no, customer_name FROM crm_customer WHERE customer_no LIKE 'TEST%';
```

## 二、功能测试用例

### 2.1 客户托管功能测试

#### 测试用例 1: 创建客户托管

**前置条件**：
- 客户经理A已登录
- 存在一个已分配给客户经理A的客户

**测试步骤**：
1. 进入"客户托管记录"页面
2. 点击"创建托管"按钮
3. 填写表单：
   - 客户ID: {测试客户ID}
   - 受托方客户经理ID: {客户经理B的用户ID}
   - 托管开始日期: {今天}
   - 托管结束日期: {30天后}
   - 托管原因: "休假期间临时托管"
4. 点击"创建"按钮

**预期结果**：
- ✅ 提示"创建托管成功"
- ✅ 托管记录列表中出现新记录
- ✅ 托管状态为"托管中"
- ✅ 客户归属关系中 `is_delegated` 字段为 true
- ✅ 客户归属关系中 `user_id` 更新为客户经理B
- ✅ 变更历史中新增一条"托管开始"记录

**实际结果**：

**测试状态**：☐ 通过 / ☐ 失败

---

#### 测试用例 2: 结束客户托管

**前置条件**：
- 存在一条"托管中"状态的托管记录

**测试步骤**：
1. 在托管记录列表中找到"托管中"的记录
2. 点击"结束托管"按钮
3. 填写结束原因: "休假结束，恢复正常维护"
4. 点击"结束"按钮

**预期结果**：
- ✅ 提示"结束托管成功"
- ✅ 托管状态更新为"已结束"
- ✅ 设置了 `end_date` 为当前日期
- ✅ 客户归属关系中 `is_delegated` 恢复为 false
- ✅ 客户归属关系中 `user_id` 恢复为原客户经理A
- ✅ 变更历史中新增一条"托管结束"记录

**实际结果**：

**测试状态**：☐ 通过 / ☐ 失败

---

#### 测试用例 3: 取消客户托管

**前置条件**：
- 存在一条"托管中"状态的托管记录

**测试步骤**：
1. 在托管记录列表中找到"托管中"的记录
2. 点击"取消托管"按钮
3. 在确认对话框中点击"确认"

**预期结果**：
- ✅ 提示"取消托管成功"
- ✅ 托管状态更新为"已取消"
- ✅ 客户归属关系恢复原状态

**实际结果**：

**测试状态**：☐ 通过 / ☐ 失败

---

### 2.2 客户认领功能测试

#### 测试用例 4: 提交客户认领申请

**前置条件**：
- 客户经理A已登录
- 存在一个无主客户（未分配或已回收）
- BPM 审批流程已配置

**测试步骤**：
1. 进入"客户认领申请"页面
2. 点击"提交申请"按钮
3. 填写表单：
   - 客户ID: {无主客户ID}
   - 申请理由: "该客户为我开发的潜在客户，希望继续跟进维护"
4. 点击"提交申请"按钮

**预期结果**：
- ✅ 提示"提交认领申请成功，等待审批"
- ✅ 申请记录列表中出现新记录
- ✅ 审批状态为"审批中"
- ✅ 流程实例ID不为空
- ✅ 审批人收到待办任务通知

**实际结果**：

**测试状态**：☐ 通过 / ☐ 失败

---

#### 测试用例 5: 审批通过客户认领申请

**前置条件**：
- 存在一条"审批中"状态的认领申请
- 审批人已登录

**测试步骤**：
1. 审批人进入"工作流 -> 待办任务"
2. 找到客户认领审批任务
3. 填写审批意见: "同意认领"
4. 点击"通过"按钮

**预期结果**：
- ✅ 提示"审批成功"
- ✅ 申请状态更新为"已通过"
- ✅ 审批意见已保存
- ✅ 审批时间已记录
- ✅ 自动创建客户归属关系（申请人成为客户经理）
- ✅ 变更历史中新增一条"认领通过"记录

**实际结果**：

**测试状态**：☐ 通过 / ☐ 失败

---

#### 测试用例 6: 取消客户认领申请

**前置条件**：
- 存在一条"审批中"状态的认领申请
- 申请人已登录

**测试步骤**：
1. 在申请列表中找到"审批中"的申请
2. 点击"取消申请"按钮
3. 在确认对话框中点击"确认"

**预期结果**：
- ✅ 提示"取消申请成功"
- ✅ 申请状态更新为"已取消"
- ✅ BPM 流程实例被终止

**实际结果**：

**测试状态**：☐ 通过 / ☐ 失败

---

### 2.3 客户退回功能测试

#### 测试用例 7: 提交客户退回申请

**前置条件**：
- 客户经理A已登录
- 客户经理A有一个已归属的客户
- BPM 审批流程已配置

**测试步骤**：
1. 进入"客户退回申请"页面
2. 点击"提交申请"按钮
3. 填写表单：
   - 客户ID: {已归属客户ID}
   - 退回原因: "客户需求超出个人能力范围，需要上级重新分配"
4. 点击"提交申请"按钮

**预期结果**：
- ✅ 提示"提交退回申请成功，等待审批"
- ✅ 申请记录列表中出现新记录
- ✅ 审批状态为"审批中"
- ✅ 审批人收到待办任务通知

**实际结果**：

**测试状态**：☐ 通过 / ☐ 失败

---

#### 测试用例 8: 审批通过客户退回申请

**前置条件**：
- 存在一条"审批中"状态的退回申请
- 审批人已登录

**测试步骤**：
1. 审批人进入"工作流 -> 待办任务"
2. 找到客户退回审批任务
3. 填写审批意见: "同意退回"
4. 点击"通过"按钮

**预期结果**：
- ✅ 提示"审批成功"
- ✅ 申请状态更新为"已通过"
- ✅ 客户归属关系状态更新为"已失效"
- ✅ 归属关系的 `expiry_date` 设置为当前日期
- ✅ 变更历史中新增一条"退回通过"记录

**实际结果**：

**测试状态**：☐ 通过 / ☐ 失败

---

### 2.4 批量操作功能测试

#### 测试用例 9: 批量分配客户

**前置条件**：
- 超级管理员已登录
- 存在多个无主客户

**测试步骤**：
1. 进入"客户归属关系管理"页面
2. 勾选 3 个客户记录
3. 点击"批量分配"按钮
4. 填写表单：
   - 归属类型: 主办
   - 归属部门ID: {部门ID}
   - 客户经理用户ID: {客户经理A的ID}
   - 查看权限: 开启
   - 维护权限: 开启
   - 备注: "批量分配测试"
5. 点击"创建"按钮

**预期结果**：
- ✅ 提示"批量分配客户成功"
- ✅ 3 条客户归属关系记录被创建
- ✅ 所有记录的状态为"生效中"
- ✅ 变更历史中新增 3 条"手动分配"记录

**实际结果**：

**测试状态**：☐ 通过 / ☐ 失败

---

#### 测试用例 10: 批量移交客户

**前置条件**：
- 超级管理员已登录
- 存在多个已分配给客户经理A的客户

**测试步骤**：
1. 进入"客户归属关系管理"页面
2. 搜索客户经理A的客户
3. 勾选 3 个客户记录
4. 点击"批量移交"按钮
5. 填写表单：
   - 目标客户经理ID: {客户经理B的ID}
   - 移交原因: "客户经理A离职，客户移交给客户经理B"
6. 点击"提交"按钮

**预期结果**：
- ✅ 提示"批量移交客户成功"
- ✅ 原 3 条归属关系状态更新为"已失效"
- ✅ 新创建 3 条归属关系，客户经理为客户经理B
- ✅ 变更历史中新增 3 条"客户移交"记录

**实际结果**：

**测试状态**：☐ 通过 / ☐ 失败

---

#### 测试用例 11: 批量回收客户

**前置条件**：
- 超级管理员已登录
- 存在多个已分配的客户

**测试步骤**：
1. 进入"客户归属关系管理"页面
2. 勾选 2 个客户记录
3. 点击"批量回收"按钮
4. 填写表单：
   - 回收原因: "客户长期未维护，收回重新分配"
5. 点击"提交"按钮

**预期结果**：
- ✅ 提示"批量回收客户成功"
- ✅ 2 条归属关系状态更新为"已失效"
- ✅ 变更历史中新增 2 条"客户回收"记录

**实际结果**：

**测试状态**：☐ 通过 / ☐ 失败

---

#### 测试用例 12: 批量变更主办部门

**前置条件**：
- 超级管理员已登录
- 存在多个已分配的客户

**测试步骤**：
1. 进入"客户归属关系管理"页面
2. 勾选 3 个客户记录
3. 点击"变更主办部门"按钮
4. 填写表单：
   - 新部门ID: {新部门ID}
   - 新客户经理ID: {新部门的客户经理ID}
   - 变更原因: "组织架构调整，客户随部门变更"
5. 点击"提交"按钮

**预期结果**：
- ✅ 提示"批量变更主办部门成功"
- ✅ 原 3 条归属关系状态更新为"已失效"
- ✅ 新创建 3 条归属关系，部门和客户经理已更新
- ✅ 变更历史中新增 3 条"主办变更"记录

**实际结果**：

**测试状态**：☐ 通过 / ☐ 失败

---

### 2.5 变更历史查询测试

#### 测试用例 13: 查询客户变更历史

**前置条件**：
- 已执行过多次客户管理操作
- 已登录系统

**测试步骤**：
1. 进入"客户管理关系变更历史"页面
2. 在搜索表单中输入客户ID
3. 点击"搜索"按钮

**预期结果**：
- ✅ 显示该客户的所有变更记录
- ✅ 记录按时间倒序排列（最新的在前）
- ✅ 每条记录显示：
  - 操作类型
  - 操作前后的部门和用户
  - 变更原因
  - 操作人
  - 操作时间
- ✅ 如果有关联的 BPM 流程，显示流程实例ID

**实际结果**：

**测试状态**：☐ 通过 / ☐ 失败

---

## 三、异常场景测试

### 3.1 权限控制测试

#### 测试用例 14: 无权限用户尝试操作

**测试步骤**：
1. 使用普通用户登录（没有分配相应权限）
2. 尝试访问"客户托管记录"页面
3. 尝试点击"创建托管"按钮

**预期结果**：
- ✅ 无法看到相关菜单，或菜单显示为灰色
- ✅ 直接访问URL会跳转到 403 页面
- ✅ API 调用返回权限不足的错误

**实际结果**：

**测试状态**：☐ 通过 / ☐ 失败

---

### 3.2 数据校验测试

#### 测试用例 15: 提交空表单

**测试步骤**：
1. 打开"创建托管"对话框
2. 不填写任何字段
3. 直接点击"创建"按钮

**预期结果**：
- ✅ 表单显示验证错误提示
- ✅ 必填字段标红
- ✅ 无法提交表单

**实际结果**：

**测试状态**：☐ 通过 / ☐ 失败

---

#### 测试用例 16: 重复托管

**测试步骤**：
1. 对同一个客户创建第一个托管记录
2. 在第一个托管未结束的情况下，尝试创建第二个托管记录

**预期结果**：
- ✅ 后端返回错误："客户已存在进行中的托管记录"
- ✅ 前端显示友好的错误提示
- ✅ 第二个托管记录创建失败

**实际结果**：

**测试状态**：☐ 通过 / ☐ 失败

---

### 3.3 并发操作测试

#### 测试用例 17: 同时操作同一客户

**测试步骤**：
1. 用户A和用户B同时登录
2. 两人同时对同一客户进行不同操作（如托管和移交）
3. 观察系统行为

**预期结果**：
- ✅ 使用数据库锁或乐观锁机制
- ✅ 后提交的操作会失败或提示冲突
- ✅ 数据保持一致性

**实际结果**：

**测试状态**：☐ 通过 / ☐ 失败

---

### 3.4 BPM 流程异常测试

#### 测试用例 18: BPM 流程配置错误

**测试步骤**：
1. 停用或删除客户认领审批流程
2. 尝试提交客户认领申请

**预期结果**：
- ✅ 系统返回友好的错误提示："审批流程未配置或已停用"
- ✅ 申请记录未创建
- ✅ 日志中记录详细错误信息

**实际结果**：

**测试状态**：☐ 通过 / ☐ 失败

---

## 四、性能测试

### 4.1 批量操作性能

#### 测试用例 19: 大批量操作

**测试数据**：100 个客户记录

**测试步骤**：
1. 选中 100 个客户记录
2. 执行批量分配操作
3. 记录操作耗时

**预期结果**：
- ✅ 操作在 10 秒内完成
- ✅ 所有记录事务一致性
- ✅ 数据库无死锁

**实际结果**：

**测试状态**：☐ 通过 / ☐ 失败

---

### 4.2 查询性能

#### 测试用例 20: 大数据量分页查询

**测试数据**：10,000 条历史记录

**测试步骤**：
1. 进入变更历史页面
2. 执行分页查询（每页 20 条）
3. 记录查询耗时

**预期结果**：
- ✅ 首页查询在 1 秒内完成
- ✅ 翻页查询在 1 秒内完成
- ✅ 使用了数据库索引

**实际结果**：

**测试状态**：☐ 通过 / ☐ 失败

---

## 五、兼容性测试

### 5.1 浏览器兼容性

测试浏览器：
- ☐ Chrome (最新版)
- ☐ Firefox (最新版)
- ☐ Safari (最新版)
- ☐ Edge (最新版)

**测试内容**：
- 页面正常显示
- 表单正常提交
- 对话框正常弹出
- 表格正常交互

---

### 5.2 响应式测试

测试分辨率：
- ☐ 1920x1080 (桌面)
- ☐ 1366x768 (笔记本)
- ☐ 768x1024 (平板竖屏)

**测试内容**：
- 页面布局正常
- 表格横向滚动
- 按钮不重叠

---

## 六、测试总结

### 6.1 测试统计

| 测试类型 | 用例总数 | 通过数 | 失败数 | 通过率 |
|---------|---------|--------|--------|--------|
| 功能测试 | 13 | - | - | -% |
| 异常测试 | 5 | - | - | -% |
| 性能测试 | 2 | - | - | -% |
| 兼容性测试 | 7 | - | - | -% |
| **合计** | **27** | **-** | **-** | **-%** |

### 6.2 发现的问题

| 编号 | 问题描述 | 严重程度 | 状态 |
|-----|---------|---------|------|
| 1 | | ☐ 高 / ☐ 中 / ☐ 低 | ☐ 待修复 / ☐ 已修复 |
| 2 | | ☐ 高 / ☐ 中 / ☐ 低 | ☐ 待修复 / ☐ 已修复 |
| 3 | | ☐ 高 / ☐ 中 / ☐ 低 | ☐ 待修复 / ☐ 已修复 |

### 6.3 测试结论

☐ **通过** - 所有测试用例通过，系统可以发布
☐ **有条件通过** - 存在次要问题，但不影响核心功能
☐ **不通过** - 存在严重问题，需要修复后重新测试

---

**测试人员**：__________
**测试日期**：__________
**测试环境**：__________
