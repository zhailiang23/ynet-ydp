<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ynet.iplatform.module.aicrm.dal.mysql.customergroupassignment.CustomerGroupAssignmentMapper">

    <!--
        一般情况下，尽可能使用 Mapper 进行 CRUD 增删改查即可。
        无法满足的场景，例如说多表关联查询，才使用 XML 编写 SQL。
        代码生成器暂时只生成 Mapper XML 文件本身，更多推荐 MybatisX 快速开发插件来生成查询。
        文档可见：https://www.iocoder.cn/MyBatis/x-plugins/
     -->

    <!-- 联表查询分页结果映射 -->
    <resultMap id="CustomerGroupAssignmentPageResultMap" type="com.ynet.iplatform.module.aicrm.controller.admin.customergroupassignment.vo.CustomerGroupAssignmentRespVO">
        <!-- 客户群归属关系基础字段 -->
        <id property="id" column="id"/>
        <result property="customerId" column="customer_id"/>
        <result property="groupId" column="group_id"/>
        <result property="assignDate" column="assign_date"/>
        <result property="assignOperatorId" column="assign_operator_id"/>
        <result property="status" column="status"/>
        <result property="remark" column="remark"/>
        <result property="createTime" column="create_time"/>
        <!-- 客户群信息字段 -->
        <result property="groupCode" column="group_code"/>
        <result property="groupName" column="group_name"/>
        <result property="groupCategory" column="group_category"/>
        <result property="memberType" column="member_type"/>
        <result property="customerSource" column="customer_source"/>
        <result property="memberCount" column="member_count"/>
        <!-- 关联用户和部门信息字段 -->
        <result property="creatorName" column="creator_name"/>
        <result property="updaterName" column="updater_name"/>
        <result property="deptName" column="dept_name"/>
        <result property="groupCreateTime" column="group_create_time"/>
        <result property="groupUpdateTime" column="group_update_time"/>
    </resultMap>

    <!-- 分页查询（联表） -->
    <select id="selectPageWithJoin" resultMap="CustomerGroupAssignmentPageResultMap">
        SELECT
            cga.id,
            cga.customer_id,
            cga.group_id,
            cga.assign_date,
            cga.assign_operator_id,
            cga.status,
            cga.remark,
            cga.create_time,
            g.group_code,
            g.group_name,
            g.group_category,
            g.member_type,
            g.customer_source,
            g.member_count,
            g.create_time AS group_create_time,
            g.update_time AS group_update_time,
            u1.nickname AS creator_name,
            u2.nickname AS updater_name,
            d.name AS dept_name
        FROM crm_customer_group_assignment cga
        LEFT JOIN crm_customer_group_info g ON cga.group_id = g.id AND g.deleted = 0
        LEFT JOIN system_users u1 ON g.creator = u1.id
        LEFT JOIN system_users u2 ON g.updater = u2.id
        LEFT JOIN system_dept d ON g.dept_id = d.id AND d.deleted = 0
        <where>
            cga.deleted = 0
            <if test="reqVO.customerId != null">
                AND cga.customer_id = #{reqVO.customerId}
            </if>
            <if test="reqVO.groupId != null">
                AND cga.group_id = #{reqVO.groupId}
            </if>
            <if test="reqVO.assignDate != null and reqVO.assignDate.length == 2">
                AND cga.assign_date BETWEEN #{reqVO.assignDate[0]} AND #{reqVO.assignDate[1]}
            </if>
            <if test="reqVO.assignOperatorId != null">
                AND cga.assign_operator_id = #{reqVO.assignOperatorId}
            </if>
            <if test="reqVO.status != null">
                AND cga.status = #{reqVO.status}
            </if>
            <if test="reqVO.remark != null and reqVO.remark != ''">
                AND cga.remark LIKE CONCAT('%', #{reqVO.remark}, '%')
            </if>
            <if test="reqVO.createTime != null and reqVO.createTime.length == 2">
                AND cga.create_time BETWEEN #{reqVO.createTime[0]} AND #{reqVO.createTime[1]}
            </if>
        </where>
        ORDER BY cga.id DESC
    </select>

</mapper>