# 客户管理关系模块部署指南

## 一、模块概述

客户管理关系模块实现了完整的客户归属管理功能，支持以下 8 个核心业务场景：

1. **客户分配** - 手动将客户分配给部门和客户经理
2. **客户移交** - 在客户经理之间移交客户
3. **客户托管** - 临时托管客户给其他客户经理
4. **客户认领** - 客户经理认领无主客户（需 BPM 审批）
5. **客户退回** - 将客户退回给上级（需 BPM 审批）
6. **客户回收** - 上级主动回收客户
7. **主办变更** - 变更客户的主办部门
8. **变更历史** - 自动记录所有客户管理关系的变更历史

## 二、部署步骤

### 2.1 数据库初始化

按顺序执行以下 SQL 脚本：

```bash
# 1. 创建表结构和增强现有表
mysql -u root -p ruoyi-vue-pro < sql/mysql/crm_customer_management_relationship.sql

# 2. 初始化数据字典
mysql -u root -p ruoyi-vue-pro < sql/mysql/crm_customer_management_relationship_dict.sql

# 3. 配置菜单和权限
mysql -u root -p ruoyi-vue-pro < sql/mysql/crm_customer_management_relationship_menu.sql
```

**重要提示**：
- 在执行 `crm_customer_management_relationship_menu.sql` 之前，请根据实际情况修改脚本中的 `parent_id`，将菜单挂载到正确的父菜单下。
- 默认情况下，新菜单会创建为顶级菜单（`parent_id = 0`）。

### 2.2 BPM 工作流配置

模块使用了 BPM 工作流引擎来处理客户认领和退回的审批流程。

#### 2.2.1 启用 BPM 模块

如果尚未启用 BPM 模块，需要：

1. 在 `backend/pom.xml` 中取消注释 BPM 模块：
```xml
<module>yudao-module-bpm</module>
```

2. 在 `backend/ynet-module-crm/pom.xml` 中确认 BPM 依赖已启用：
```xml
<dependency>
    <groupId>cn.iocoder.boot</groupId>
    <artifactId>yudao-module-bpm</artifactId>
    <version>${revision}</version>
</dependency>
```

#### 2.2.2 创建审批流程定义

登录系统后台，进入 **工作流管理 -> 流程管理 -> 流程定义**，创建以下两个流程：

**1. 客户认领审批流程**
- 流程标识（Key）: `crm_customer_claim`
- 流程名称: 客户认领审批
- 流程描述: 客户经理申请认领无主客户的审批流程
- 审批节点配置:
  - 第一级: 部门主管审批
  - 第二级: 分管领导审批（可选）
  - 结束后自动创建客户归属关系

**2. 客户退回审批流程**
- 流程标识（Key）: `crm_customer_return`
- 流程名称: 客户退回审批
- 流程描述: 客户经理申请退回客户给上级的审批流程
- 审批节点配置:
  - 第一级: 部门主管审批
  - 结束后自动失效当前归属关系

**流程配置建议**：
1. 使用 **Simple 模式**（仿钉钉）设计流程，操作更简单
2. 配置审批人规则：
   - 部门主管: 发起人的直属上级
   - 分管领导: 发起人所在部门的上级部门负责人
3. 配置表单字段：
   - 客户ID（必填）
   - 申请理由（必填，文本域）
   - 审批意见（选填，审批节点填写）

### 2.3 后端配置

#### 2.3.1 重新编译项目

```bash
cd backend
mvn clean compile
```

#### 2.3.2 重启服务

```bash
cd yudao-server
mvn spring-boot:run -Dspring-boot.run.profiles=local
```

### 2.4 前端配置

前端无需额外配置，菜单和路由会自动从后端加载。

#### 2.4.1 重启前端服务

```bash
cd frontend
pnpm dev:antd
```

#### 2.4.2 验证页面

访问以下页面确认功能正常：
- 客户托管记录: http://localhost:5666/aicrm/customer-delegation
- 客户认领申请: http://localhost:5666/aicrm/customer-claim
- 客户退回申请: http://localhost:5666/aicrm/customer-return
- 客户归属关系: http://localhost:5666/aicrm/customer-assignment（增强版，包含批量操作）

### 2.5 权限配置

1. 登录系统后台
2. 进入 **系统管理 -> 菜单管理**
3. 找到新创建的菜单项，根据需要调整：
   - 菜单顺序（sort）
   - 父菜单（parent_id）
   - 图标（icon）
4. 进入 **系统管理 -> 角色管理**
5. 为相应角色分配权限

**权限说明**：

| 功能 | 权限标识 | 说明 |
|-----|---------|-----|
| 查询客户托管 | `aicrm:customer-delegation:query` | 查看托管记录列表 |
| 创建客户托管 | `aicrm:customer-delegation:create` | 创建新的托管记录 |
| 结束客户托管 | `aicrm:customer-delegation:update` | 结束进行中的托管 |
| 取消客户托管 | `aicrm:customer-delegation:delete` | 取消进行中的托管 |
| 查询认领申请 | `aicrm:customer-claim:query` | 查看认领申请列表 |
| 提交认领申请 | `aicrm:customer-claim:create` | 提交新的认领申请 |
| 取消认领申请 | `aicrm:customer-claim:delete` | 取消待审批的申请 |
| 查询退回申请 | `aicrm:customer-return:query` | 查看退回申请列表 |
| 提交退回申请 | `aicrm:customer-return:create` | 提交新的退回申请 |
| 取消退回申请 | `aicrm:customer-return:delete` | 取消待审批的申请 |
| 批量分配客户 | `aicrm:customer-assignment:assign` | 批量分配客户 |
| 批量移交客户 | `aicrm:customer-assignment:transfer` | 批量移交客户 |
| 批量回收客户 | `aicrm:customer-assignment:reclaim` | 批量回收客户 |
| 变更主办部门 | `aicrm:customer-assignment:change-dept` | 批量变更主办部门 |

## 三、功能使用说明

### 3.1 客户托管

**使用场景**：客户经理临时无法维护客户（如休假、出差），需要临时托管给其他客户经理。

**操作步骤**：
1. 进入 **客户托管记录** 页面
2. 点击 **创建托管** 按钮
3. 填写表单：
   - 客户ID：要托管的客户
   - 受托方客户经理ID：接收托管的客户经理
   - 托管开始日期：托管生效日期
   - 托管结束日期（可选）：托管到期日期
   - 托管原因：说明托管原因
4. 提交后，系统自动：
   - 创建托管记录
   - 更新客户归属关系（标记为托管状态）
   - 记录变更历史

**结束托管**：
- 点击 **结束托管** 按钮
- 填写结束原因
- 系统自动恢复原客户归属关系

### 3.2 客户认领

**使用场景**：客户经理发现无主客户（未分配或已回收的客户），申请认领该客户。

**操作步骤**：
1. 进入 **客户认领申请** 页面
2. 点击 **提交申请** 按钮
3. 填写表单：
   - 客户ID：要认领的客户
   - 申请理由：详细说明认领原因（必填）
4. 提交后，系统自动：
   - 创建认领申请记录
   - 启动 BPM 审批流程（流程实例ID会显示在列表中）
   - 发送审批通知给审批人

**审批流程**：
1. 审批人在 **工作流 -> 待办任务** 中处理审批
2. 审批通过后，系统自动：
   - 创建客户归属关系（申请人成为客户经理）
   - 更新申请状态为"已通过"
   - 记录变更历史
3. 审批拒绝后，系统自动更新申请状态为"已拒绝"

**取消申请**：
- 只能取消"审批中"状态的申请
- 点击 **取消申请** 按钮
- 确认后系统更新申请状态为"已取消"

### 3.3 客户退回

**使用场景**：客户经理认为无法继续维护某客户，需要退回给上级重新分配。

**操作步骤**：
1. 进入 **客户退回申请** 页面
2. 点击 **提交申请** 按钮
3. 填写表单：
   - 客户ID：要退回的客户
   - 退回原因：详细说明退回原因（必填）
4. 提交后，系统自动启动 BPM 审批流程

**审批流程**：
1. 审批人在待办任务中处理
2. 审批通过后，系统自动：
   - 失效当前客户归属关系
   - 更新申请状态为"已通过"
   - 记录变更历史
3. 审批拒绝后，维持现有归属关系

### 3.4 批量操作

**使用场景**：需要对多个客户进行相同的操作。

**操作步骤**：
1. 进入 **客户归属关系管理** 页面
2. 勾选要操作的客户记录（支持多选）
3. 点击工具栏的批量操作按钮：
   - **批量分配**：将选中的客户分配给指定部门和客户经理
   - **批量移交**：将选中的客户移交给指定客户经理
   - **批量回收**：回收选中的客户（失效归属关系）
   - **变更主办部门**：变更选中客户的主办部门和客户经理
4. 在弹出的表单中填写必要信息
5. 提交后，系统批量处理所有选中的客户

**注意事项**：
- 所有批量操作在一个事务中执行，要么全部成功，要么全部失败
- 每个客户的操作都会记录到变更历史
- 建议一次批量操作不超过 100 个客户

### 3.5 变更历史查询

**使用场景**：追溯客户归属关系的变更记录。

**查询位置**：
- 方式1：在 **客户管理关系变更历史** 页面查询所有变更记录
- 方式2：在客户详情页查看该客户的变更历史

**历史记录包含信息**：
- 操作类型（分配、移交、托管、认领、退回、回收、变更）
- 操作前的部门和客户经理
- 操作后的部门和客户经理
- 变更原因
- 操作人
- 操作时间
- 关联的 BPM 流程实例ID（如果有）

## 四、数据字典

系统使用以下数据字典，可在 **系统管理 -> 字典管理** 中查看和维护：

### 4.1 归属操作类型 (aicrm_assignment_operation_type)

| 字典值 | 字典标签 | 说明 |
|-------|---------|-----|
| manual_assign | 手动分配 | 手动将客户分配给客户经理 |
| transfer | 客户移交 | 客户经理之间移交客户 |
| delegation_start | 托管开始 | 开始托管客户给其他客户经理 |
| delegation_end | 托管结束 | 结束客户托管，恢复原归属 |
| claim_approved | 认领通过 | 客户认领申请审批通过 |
| return_approved | 退回通过 | 客户退回申请审批通过 |
| reclaim | 客户回收 | 上级主动回收客户 |
| dept_transfer | 主办变更 | 变更客户的主办部门 |

### 4.2 审批状态 (aicrm_process_status)

| 字典值 | 字典标签 | 颜色 |
|-------|---------|-----|
| 1 | 审批中 | 蓝色 |
| 2 | 已通过 | 绿色 |
| 3 | 已拒绝 | 红色 |
| 4 | 已取消 | 灰色 |

### 4.3 托管状态 (aicrm_delegation_status)

| 字典值 | 字典标签 | 说明 |
|-------|---------|-----|
| 0 | 已结束 | 托管已正常结束 |
| 1 | 托管中 | 托管进行中 |
| 2 | 已取消 | 托管被提前取消 |

### 4.4 归属状态 (aicrm_assignment_status)

| 字典值 | 字典标签 | 说明 |
|-------|---------|-----|
| 0 | 已失效 | 归属关系已失效 |
| 1 | 生效中 | 归属关系生效中 |
| 2 | 待生效 | 归属关系待生效（未到生效日期）|

## 五、API 接口文档

启动服务后，访问以下地址查看 API 文档：
- Swagger UI: http://localhost:48080/swagger-ui/index.html
- Knife4j: http://localhost:48080/doc.html

主要接口：

### 5.1 客户托管

- `POST /aicrm/customer-delegation/create` - 创建托管
- `PUT /aicrm/customer-delegation/end` - 结束托管
- `DELETE /aicrm/customer-delegation/cancel` - 取消托管
- `GET /aicrm/customer-delegation/page` - 分页查询
- `GET /aicrm/customer-delegation/get` - 获取详情

### 5.2 客户认领

- `POST /aicrm/customer-claim-application/apply` - 提交申请
- `DELETE /aicrm/customer-claim-application/cancel` - 取消申请
- `GET /aicrm/customer-claim-application/page` - 分页查询
- `GET /aicrm/customer-claim-application/get` - 获取详情

### 5.3 客户退回

- `POST /aicrm/customer-return-application/apply` - 提交申请
- `DELETE /aicrm/customer-return-application/cancel` - 取消申请
- `GET /aicrm/customer-return-application/page` - 分页查询
- `GET /aicrm/customer-return-application/get` - 获取详情

### 5.4 批量操作

- `POST /aicrm/customer-assignment/assign` - 批量分配
- `POST /aicrm/customer-assignment/transfer` - 批量移交
- `POST /aicrm/customer-assignment/reclaim` - 批量回收
- `POST /aicrm/customer-assignment/change-dept` - 变更主办部门

## 六、常见问题

### 6.1 菜单不显示

**原因**：
1. SQL 脚本未执行
2. 角色未分配权限
3. 菜单被设置为隐藏（visible=0）
4. 前端缓存未清除

**解决方法**：
1. 检查数据库中菜单是否已创建
2. 在角色管理中分配权限
3. 清除浏览器缓存，重新登录

### 6.2 BPM 审批不生效

**原因**：
1. BPM 模块未启用
2. 流程定义未创建或流程标识（Key）不匹配
3. 流程定义未发布

**解决方法**：
1. 确认 `yudao-module-bpm` 依赖已启用
2. 检查流程定义的 Key 必须是：
   - 客户认领: `crm_customer_claim`
   - 客户退回: `crm_customer_return`
3. 在流程管理中发布流程定义

### 6.3 批量操作失败

**原因**：
1. 选中的客户记录中存在无效数据
2. 权限不足
3. 数据库事务失败

**解决方法**：
1. 检查选中的客户记录是否都是有效的
2. 确认用户有相应的批量操作权限
3. 查看后端日志获取详细错误信息
4. 减少一次批量操作的数量

### 6.4 托管状态异常

**原因**：
1. 托管记录异常结束但客户归属关系未恢复
2. 数据不一致

**解决方法**：
1. 查询客户归属关系表，检查 `is_delegated` 字段
2. 查询托管记录表，检查 `delegation_status` 字段
3. 手动修复数据不一致的记录
4. 联系开发人员排查根本原因

### 6.5 权限代码报错

**错误示例**：
```
Access is denied (用户没有该操作权限)
```

**解决方法**：
1. 在 **系统管理 -> 角色管理** 中为用户角色分配相应权限
2. 如果是新增的权限，确认菜单配置 SQL 已执行
3. 重新登录系统，刷新权限缓存

## 七、性能优化建议

### 7.1 数据库索引

建议为以下字段添加索引（如果尚未添加）：

```sql
-- 客户归属关系表
ALTER TABLE crm_customer_assignment ADD INDEX idx_customer_id (customer_id);
ALTER TABLE crm_customer_assignment ADD INDEX idx_user_id (user_id);
ALTER TABLE crm_customer_assignment ADD INDEX idx_status (status);

-- 客户托管记录表
ALTER TABLE crm_customer_delegation ADD INDEX idx_customer_id (customer_id);
ALTER TABLE crm_customer_delegation ADD INDEX idx_from_user_id (from_user_id);
ALTER TABLE crm_customer_delegation ADD INDEX idx_to_user_id (to_user_id);
ALTER TABLE crm_customer_delegation ADD INDEX idx_delegation_status (delegation_status);

-- 客户认领申请表
ALTER TABLE crm_customer_claim_application ADD INDEX idx_customer_id (customer_id);
ALTER TABLE crm_customer_claim_application ADD INDEX idx_apply_user_id (apply_user_id);
ALTER TABLE crm_customer_claim_application ADD INDEX idx_process_status (process_status);

-- 客户退回申请表
ALTER TABLE crm_customer_return_application ADD INDEX idx_customer_id (customer_id);
ALTER TABLE crm_customer_return_application ADD INDEX idx_apply_user_id (apply_user_id);
ALTER TABLE crm_customer_return_application ADD INDEX idx_process_status (process_status);

-- 客户管理关系变更历史表
ALTER TABLE crm_customer_assignment_history ADD INDEX idx_customer_id (customer_id);
ALTER TABLE crm_customer_assignment_history ADD INDEX idx_operation_type (operation_type);
ALTER TABLE crm_customer_assignment_history ADD INDEX idx_change_date (change_date);
```

### 7.2 批量操作优化

- 建议单次批量操作不超过 100 条记录
- 对于超大批量操作，考虑使用异步任务
- 使用批量插入而非逐条插入

### 7.3 查询优化

- 分页查询时使用合适的 pageSize（推荐 20-50）
- 避免使用 `SELECT *`，只查询需要的字段
- 使用缓存存储常用的字典数据

## 八、联系和支持

如遇到问题或需要技术支持，请：
1. 查看本文档的常见问题章节
2. 查看后端日志文件获取详细错误信息
3. 联系项目开发团队

---

**最后更新时间**: 2025-10-31
**文档版本**: v1.0
**适用系统版本**: RuoYi-Vue-Pro v2025.10
