# 客户认领流程后置通知实现说明

## 功能概述

实现客户认领审批流程结束后的自动化处理:
- 当审批**通过**时,自动将客户分配给申请人
- 当审批**不通过**或**取消**时,不做任何处理

## 实现方案

### 1. BPM流程后置通知机制

BPM模块提供了流程后置通知机制(`processAfterTriggerSetting`),在流程实例结束并且状态为**审批通过**时,会自动调用配置的HTTP接口。

**触发时机**: `BpmProcessInstanceServiceImpl.java:1016-1027`
```java
// 4. 流程后置通知
if (Objects.equals(status, BpmProcessInstanceStatusEnum.APPROVE.getStatus())) {
    BpmProcessDefinitionInfoDO processDefinitionInfo = processDefinitionService.
            getProcessDefinitionInfo(instance.getProcessDefinitionId());
    if (ObjUtil.isNotNull(processDefinitionInfo) &&
            ObjUtil.isNotNull(processDefinitionInfo.getProcessAfterTriggerSetting())) {
        BpmModelMetaInfoVO.HttpRequestSetting setting = processDefinitionInfo.getProcessAfterTriggerSetting();

        BpmHttpRequestUtils.executeBpmHttpRequest(instance,
                setting.getUrl(), setting.getHeader(), setting.getBody(), true, setting.getResponse());
    }
}
```

**请求特点**:
- 请求方式: POST
- 自动携带: tenant-id (多租户ID)
- 自动携带: processInstanceId (流程实例ID)

### 2. 回调接口实现

#### 2.1 Controller - CustomerClaimCallbackController

**文件路径**: `ynet-module-crm/src/main/java/cn/iocoder/yudao/module/aicrm/controller/admin/customerclaim/CustomerClaimCallbackController.java`

**接口地址**: `POST /admin-api/aicrm/customer-claim/callback/process-end`

**功能**:
- 接收BPM流程引擎的后置通知
- 调用Service层处理业务逻辑
- 异常处理:即使失败也返回成功,避免影响流程引擎

**权限配置**: 无需身份验证(已在SecurityConfiguration中配置为白名单)

#### 2.2 Service - CustomerClaimService

**新增方法**: `handleClaimProcessEnd(String processInstanceId)`

**文件路径**: `ynet-module-crm/src/main/java/cn/iocoder/yudao/module/aicrm/service/customerclaim/CustomerClaimServiceImpl.java:196-218`

**处理逻辑**:
```java
@Override
@Transactional(rollbackFor = Exception.class)
public void handleClaimProcessEnd(String processInstanceId) {
    // 1. 根据流程实例ID查询申请记录
    CustomerClaimApplicationDO application = claimApplicationMapper.selectOne(
            new LambdaQueryWrapper<CustomerClaimApplicationDO>()
                    .eq(CustomerClaimApplicationDO::getProcessInstanceId, processInstanceId)
    );

    if (application == null) {
        throw exception(CUSTOMER_CLAIM_APPLICATION_NOT_EXISTS);
    }

    // 2. 判断流程审批结果
    // processStatus: 1-审批中, 2-审批通过, 3-审批拒绝, 4-已取消
    if (application.getProcessStatus() != 2) {
        // 如果不是审批通过状态,则不处理
        return;
    }

    // 3. 审批通过,自动分配客户
    autoAssignCustomerAfterClaimApproved(application.getId());
}
```

#### 2.3 自动分配客户逻辑

**方法**: `autoAssignCustomerAfterClaimApproved(Long applicationId)`

**功能**:
1. 创建客户归属关系(`customer_assignment`)
   - 归属类型: 主办 (assignmentType = 1)
   - 分配权限: 查看权限 + 维护权限
   - 操作人: 申请人自己

2. 记录操作历史(`customer_assignment_history`)
   - 操作类型: claim (认领)
   - 记录从无归属到有归属的变化
   - 关联流程实例ID

### 3. 数据库配置

**配置脚本**: `backend/sql/mysql/customer_claim_process_callback.sql`

**配置内容**:
```sql
UPDATE bpm_process_definition_info
SET process_after_trigger_setting = JSON_OBJECT(
    'url', 'http://localhost:48080/admin-api/aicrm/customer-claim/callback/process-end',
    'header', JSON_ARRAY(),
    'body', JSON_ARRAY(),
    'response', JSON_ARRAY()
)
WHERE process_definition_id LIKE 'customer_claim%';
```

**重要说明**:
- 生产环境需要修改URL为实际的服务地址
- 如果使用内网地址,确保BPM服务能访问到CRM服务

## 配置步骤

### 1. 执行SQL配置脚本

```bash
mysql -h localhost -u root -p ruoyi-vue-pro < backend/sql/mysql/customer_claim_process_callback.sql
```

### 2. 重启应用

配置修改后需要重启应用使配置生效。

### 3. 测试验证

1. 创建一个客户认领申请
2. 审批流程通过
3. 检查:
   - 客户归属表(`customer_assignment`)是否有新记录
   - 归属历史表(`customer_assignment_history`)是否有记录
   - 申请表(`customer_claim_application`)状态是否为已通过

## 流程状态说明

`customer_claim_application.process_status` 字段说明:
- 1: 审批中
- 2: 审批通过 (会触发自动分配)
- 3: 审批拒绝 (不处理)
- 4: 已取消 (不处理)

## 注意事项

1. **事务处理**: `handleClaimProcessEnd`方法使用了`@Transactional`,确保客户分配和历史记录操作的原子性

2. **异常处理**: Controller层的异常处理确保即使业务处理失败,也返回成功给BPM引擎,避免影响流程状态

3. **幂等性**: 由于客户认领申请记录和流程实例是一对一关系,天然具有幂等性

4. **日志记录**: 使用`@Slf4j`记录关键操作日志,便于问题排查

5. **权限控制**: 回调接口已配置为白名单,无需身份验证(通过SecurityConfiguration配置)

## 扩展说明

如果需要在流程的其他节点添加通知,可以使用:
- `processBeforeTriggerSetting`: 流程前置通知 (流程开始时)
- `taskBeforeTriggerSetting`: 任务前置通知 (任务创建时)
- `taskAfterTriggerSetting`: 任务后置通知 (任务完成时)

配置方式与`processAfterTriggerSetting`类似。

## 相关文件清单

1. **Controller**
   - `CustomerClaimCallbackController.java` (新增)

2. **Service**
   - `CustomerClaimService.java` (新增方法)
   - `CustomerClaimServiceImpl.java` (新增方法实现)

3. **Security配置**
   - `aicrm/framework/security/config/SecurityConfiguration.java` (新增)

4. **SQL脚本**
   - `customer_claim_process_callback.sql` (新增)

5. **文档**
   - `客户认领流程后置通知实现说明.md` (本文件)
