# GitLab CI/CD 配置文件
# GitLab 版本: 17.1.8 Community Edition
# 项目: iplatform-server (backend)
# 功能: 自动构建、推送 Docker 镜像、零停机部署到 FAT 环境

# 定义 CI/CD 阶段
stages:
  - build      # 构建 Spring Boot JAR 和 Docker 镜像
  - deploy     # 部署到服务器
  - cleanup    # 清理旧镜像

# 全局变量
variables:
  # Harbor 配置
  HARBOR_URL: "192.168.152.56"
  HARBOR_PROJECT: "sysadmin-2025"
  IMAGE_NAME: "${HARBOR_URL}/${HARBOR_PROJECT}/iplatform-server"

  # 部署服务器配置
  DEPLOY_SERVER: "192.168.153.111"
  DEPLOY_USER: "root"
  DEPLOY_DIR: "/root/zhailiang/iplatform-server"
  CONTAINER_PORT: "48080"

  # Spring Boot 环境配置
  SPRING_PROFILE: "fat"  # 激活 FAT 环境配置

  # Maven 配置
  MAVEN_OPTS: "-Dmaven.repo.local=$CI_PROJECT_DIR/.m2/repository -Dmaven.test.skip=true"
  MAVEN_CLI_OPTS: "--batch-mode --errors --fail-at-end --show-version"

  # Docker 配置
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: ""

  # GitLab Runner 配置
  # if-not-present: 优先使用本地缓存镜像，避免每次都从 Docker Hub 拉取
  # 服务器已配置 Docker 镜像加速器 (DaoCloud, DockerHub.icu, 1panel, awsl9527)
  PULL_POLICY: if-not-present
  FF_USE_FASTZIP: "true"
  ARTIFACT_COMPRESSION_LEVEL: "fast"
  CACHE_COMPRESSION_LEVEL: "fast"

# 仅在推送到 master 分支时触发
workflow:
  rules:
    - if: $CI_COMMIT_BRANCH == "master"
      when: always
    - when: never

# Maven 依赖缓存
# 使用项目级缓存键，所有分支共享 Maven 依赖
# 这样可以避免重复下载相同的依赖包
cache:
  key: "maven-cache"  # 固定缓存键，所有构建共享
  paths:
    - .m2/repository/
  policy: pull-push  # 每次构建都尝试拉取缓存，结束后更新缓存

# ============================================
# 阶段 1: 构建 Spring Boot JAR 和 Docker 镜像
# ============================================
build-and-push:
  stage: build
  image: maven:3.9.6-eclipse-temurin-21-alpine
  variables:
    GIT_STRATEGY: fetch
  before_script:
    - echo "=========================================="
    - echo "开始构建 Spring Boot 应用"
    - echo "Commit hash ${CI_COMMIT_SHORT_SHA}"
    - echo "Build number ${CI_PIPELINE_IID}"
    - echo "=========================================="
    - java -version
    - mvn -version
    - echo "配置 Maven 阿里云镜像..."
    - mkdir -p ~/.m2
    - echo '<?xml version="1.0" encoding="UTF-8"?>' > ~/.m2/settings.xml
    - echo '<settings>' >> ~/.m2/settings.xml
    - echo '  <mirrors>' >> ~/.m2/settings.xml
    - echo '    <mirror>' >> ~/.m2/settings.xml
    - echo '      <id>aliyun</id>' >> ~/.m2/settings.xml
    - echo '      <mirrorOf>central</mirrorOf>' >> ~/.m2/settings.xml
    - echo '      <name>Aliyun Maven</name>' >> ~/.m2/settings.xml
    - echo '      <url>https://maven.aliyun.com/repository/public</url>' >> ~/.m2/settings.xml
    - echo '    </mirror>' >> ~/.m2/settings.xml
    - echo '  </mirrors>' >> ~/.m2/settings.xml
    - echo '</settings>' >> ~/.m2/settings.xml
  script:
    - echo "步骤 1 清理并打包 Spring Boot 项目..."
    - mvn $MAVEN_CLI_OPTS clean package $MAVEN_OPTS -DskipTests
    - ls -lh iplatform-server/target/
    - test -f iplatform-server/target/iplatform-server.jar || (echo "错误 JAR 文件不存在" && exit 1)
    - echo "步骤 2 构建 Docker 镜像..."
    - cd iplatform-server
    - apk add --no-cache docker-cli
    - docker build -t ${IMAGE_NAME}:${CI_PIPELINE_IID} .
    - docker tag ${IMAGE_NAME}:${CI_PIPELINE_IID} ${IMAGE_NAME}:latest
    - echo "步骤 3 推送镜像到 Harbor..."
    - docker login ${HARBOR_URL} -u search -p Search123
    - docker push ${IMAGE_NAME}:${CI_PIPELINE_IID}
    - docker push ${IMAGE_NAME}:latest
    - docker logout ${HARBOR_URL}
    - echo "=========================================="
    - echo "构建成功"
    - echo "镜像 ${IMAGE_NAME}:${CI_PIPELINE_IID}"
    - echo "=========================================="
  # 注意: JAR 文件已打包到 Docker 镜像中，无需保存为 artifact
  # 如果需要下载 JAR，可以从 Docker 镜像中提取:
  # docker run --rm ${IMAGE_NAME}:${CI_PIPELINE_IID} cat /app/iplatform-server.jar > iplatform-server.jar
  tags:
    - docker
  only:
    - master

# ============================================
# 阶段 2: 部署到 FAT 环境
# ============================================
deploy-to-fat:
  stage: deploy
  image: alpine:latest
  variables:
    GIT_STRATEGY: fetch
  before_script:
    - sed -i 's/dl-cdn.alpinelinux.org/mirrors.aliyun.com/g' /etc/apk/repositories
    - apk add --no-cache openssh-client bash curl
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - echo '-----BEGIN RSA PRIVATE KEY-----' > ~/.ssh/id_rsa
    - echo 'MIIJKgIBAAKCAgEAxHX3vcOKkOPL8sAbX/xQAcw5F2ziyEVoPpW9nVGWL0GPa9Wq' >> ~/.ssh/id_rsa
    - echo 'ecYJ7SuXdKEEOZeU5w4doGx59Po+9vzzgv6u9Hz1CtjPPcfLKEt6EvKmKAKyeDQV' >> ~/.ssh/id_rsa
    - echo 'i6T0w+Ymc6cqMTf+aLduZvbyFyZ4d6rNYfLpneWXYDRfw+Eg4hcZkj38TLlv3B6S' >> ~/.ssh/id_rsa
    - echo 'nKgTJgGOtPUlS0cywzUC5xueiGl7kzdZ8pKOr1dxB/w7+GXIbp2qwuKB+EMZ1VWx' >> ~/.ssh/id_rsa
    - echo 'QgH5WXBJUpb9RggwjziiAtx4LuqCWDdJMzEKcaoWcrbBUKMvRPCKH194fWocY9Sp' >> ~/.ssh/id_rsa
    - echo 'uGKIbujRxJ/B3rCywlknFuO2beWprhYT9AnX/TsK//y7D79M5NDjGba47XiTxZgT' >> ~/.ssh/id_rsa
    - echo 'LRxUXjs0HTUtQFvlCax5WFslL6SCr/YYu5EL+ieDSvjIrHfToTtZyo4094ulRvnD' >> ~/.ssh/id_rsa
    - echo 'i5t+Tm+Nad0A+itaxjteoFN3meMAUvmw59oRckosuqmlFgUY9G3gp7Ti4TPzh5Td' >> ~/.ssh/id_rsa
    - echo 'GnqVPfTlUMkP8qZusmUv7lvc1pJo+hHKGjePU1j/BQLWsoglruaZgdXbjyYtqNkC' >> ~/.ssh/id_rsa
    - echo '9HiL7l6zLNII2KSeH4TDiTWRbIr6brQ7M0wrrKugc74homTsoHlqfkYcuxv9be6G' >> ~/.ssh/id_rsa
    - echo 'd2HQEf2pUKPs0MYTW/ksCzUoBijTKwAWaDlyKqG0P01pb9uBhwBgs2/SxgsCAwEA' >> ~/.ssh/id_rsa
    - echo 'AQKCAgA4CH10fkUTNiWBQxGLuucG3DycVc4I2OL2lrbSG+b963EAjJxmxvklz/0O' >> ~/.ssh/id_rsa
    - echo 'oq4VzwoFLJ1+l/Hg0U8MGvFJN2KnEMzDHztcn5NuFrjmlpaVas+EQTaz8YRuK0Jk' >> ~/.ssh/id_rsa
    - echo 'UhVSnGnPbCHs9BnwSGSrnOefPC0tf8JBCi8WKyu50GTWtR80st8YpQ+j5rwvZtpQ' >> ~/.ssh/id_rsa
    - echo '+mp8of30dzYwvEvnFE7OmkbpTKutjv8KDAL+wej8w7Nkij4PlPPVSO+Zp/56Z/BB' >> ~/.ssh/id_rsa
    - echo 'whbS1psi/kAXGNKebvxmNL6H/0C/Uoe8iCty2FgvDXwXnp87Bfy67HjLwi6vk2/g' >> ~/.ssh/id_rsa
    - echo '6L/ex/70N4FSoffyOELBCEMAo54adws1tJn3ex5nvI9DW+zOGIJv6cpgAqumMXoH' >> ~/.ssh/id_rsa
    - echo 'us1bjJ46DMbFNgnz4ASsiNnHMcibcAFZI4zoAjWyPXNL9aGzygAnBM9Mytu/B8gS' >> ~/.ssh/id_rsa
    - echo 'Me+sy7J+0V8L+EUCt9Xjhe54Esvr8EVLdXINNnMvi5EJ2+xE3KMC10Lo/vmEJRkR' >> ~/.ssh/id_rsa
    - echo 'U3W9FxYybbVzbFiulH5BMMHKQKCD7QzajFH1UdsJb/VoHiIW/MhXOmNpmXZyO2aC' >> ~/.ssh/id_rsa
    - echo 'hWZBbcsx8K/8+9m5FdQQB9TJf2UX7wSl4Jj1gEKo8hdGNLkXMpGNrVNWFFZlHSl+' >> ~/.ssh/id_rsa
    - echo 'n4XNF9SbP7NcWZ1lyfQSxc4fqYG6YaFvFvA7TCcxHo55o2pzwQKCAQEA+VN1zqkY' >> ~/.ssh/id_rsa
    - echo 'V/OuU4M6c+t/oacwN6XHTk7tQcS7I5f/pnHBDSXHvx+lkoLq7osWRz4ujNsaTRg9' >> ~/.ssh/id_rsa
    - echo 'hlDhj2IM7Fv5zGmNkpVFW5a4oJ4GMLO54cbMqmff10JEF5A7Ns6f4i1dhwMv3rx6' >> ~/.ssh/id_rsa
    - echo 'K8dnGdl8yI3plPCBrOvvcEKgOLRj9NjPfhonCh2nkNehiUrZPMEfyo3jzHX/4NoB' >> ~/.ssh/id_rsa
    - echo 'Vt5h/BEasfyQNF4UUZhCG6aSjH6w2sqV4usjZK5btVZrQCLIVrtYmpy7ft+bieqw' >> ~/.ssh/id_rsa
    - echo 'i6MDDJVUyoaCsOEpHsS4RlrI9pAtjivXgyKctCfwWN0s6AwwiiPPPe4bwYcL8yr1' >> ~/.ssh/id_rsa
    - echo 'OV2/n5dphpWkIwKCAQEAybg93r/KhZAQ7ETBeGC2Wp1cnlr3SyZam4jJKJOvx/9T' >> ~/.ssh/id_rsa
    - echo 'pbmLELhvCQ/eQ3Q5z3oEBaMUY/NURrq7BuLZZPYPuEbUyAFGmoIL+zZAT4dknfQH' >> ~/.ssh/id_rsa
    - echo 'iab4Q3CfvWe4Rv4jWyhNkck82pxQkgpqqvXWNz7hCckD5xipuiQeHDVwWvBnu/rK' >> ~/.ssh/id_rsa
    - echo 'FVWk1Jsbi6dWCjA3Xa7s3tzz6jYVAmEq6Oe5UhPYjqnHqKI/JIYYd7+bMXd4VWKR' >> ~/.ssh/id_rsa
    - echo 'PuYmtcVfomyiNASFHtCGuvYizRMWiVt1JkT4O6o3mfB+dVnw9s1NJHsXdQPo6fMr' >> ~/.ssh/id_rsa
    - echo 'kitUJmO6a1Fnj/UK743don5g+0KOn7H6P1HOBXNg+QKCAQEA2NRHePG/1QV8Tu6q' >> ~/.ssh/id_rsa
    - echo 'UBO3jLtciJioyyaC2Zag9WSEFZmKPcfkfgeks9UdQVU+i7i9PQxzRCbXos8GSu8H' >> ~/.ssh/id_rsa
    - echo 'tCqNBMOrNpaQmgVrDWxAj+xNtNdyOKRbm9XqZ9+sT47Epyuy0e7om7moOhiRRn7J' >> ~/.ssh/id_rsa
    - echo 'MZWRVVEQRXVuZ1/Z/VaMM2y2jsFpwDdn+eQ9fKvWXyrJXhulx7O7Uy3kykpeRpwN' >> ~/.ssh/id_rsa
    - echo 'bkrqklBbNVbH70oe2wZ3Ad/7GDxMLIwh/4NnhIB7YEpP1S6HNOB8YSX0YYvj4/ae' >> ~/.ssh/id_rsa
    - echo 'pf7y+6blXvfQFodvjFZ499KS+12HkHnHYVEAc9HeCNT5r686/kRXFSP/3eL0+nLw' >> ~/.ssh/id_rsa
    - echo 'd/X9pwKCAQEAxMRr1bTQIKj/WPlYn8v3FT0a831YbH3lNIKhdmtZtIVjWu06sfy2' >> ~/.ssh/id_rsa
    - echo 'kuhfrvzYx4IGGlmRsk3Rj4zmkzkFRm6ftumg9dgIvv7MISgyY2F2zH0WPTgaQ+7A' >> ~/.ssh/id_rsa
    - echo 'Y0mhf963LlyKDgN20OhZz5tJoapcY1d6vMjQfcSZC3HfzTRzfMG07rEcHuOD/b+v' >> ~/.ssh/id_rsa
    - echo 'hvKcAyQ1XbUcaeiuJXDL3Z5a9QXUyDODsuX6VIyvezky9Nx6zi3zu5aCiBCJAhad' >> ~/.ssh/id_rsa
    - echo 'yxqcvpEKKZzPT+B44gIUobgM9l+gpNLNmeP19xLc8mIhNcy8fPBraopBnjuVwjzV' >> ~/.ssh/id_rsa
    - echo 'w4mMs+gb2sFPyQnuICo0ZaJ+sPVjOf3qQQKCAQEA2Ohy+v9O+COFo+VBcrS3kfD/' >> ~/.ssh/id_rsa
    - echo 'jQ9Zh0V8a2MZpk1UXNIAdnATsCrXJEL7etwfTSANJJjscYAmksUg70yw4BpJKq7V' >> ~/.ssh/id_rsa
    - echo '1VJHV5B39ytYELHpRRYPN6vEeG+SVHkbJdvzabWAu6Jtqyc/8sPxj1CTJWGpDozY' >> ~/.ssh/id_rsa
    - echo 'ZQQ/upGcgO26hPQMb3w+tRU/a5gLUR96vRcryJM97G8+jlV/o0Ea4GGQ1GBW0B/S' >> ~/.ssh/id_rsa
    - echo 'fvNqVFFgO6QYjoDworgRzHk0jd/yEq2vdaCBQi5oU9HRGszADnYSV3Aa8FLVGOGL' >> ~/.ssh/id_rsa
    - echo 'EG/VztERA0WSrelxUuZrZ8BI7DtirED7L6tccANLJGFLx8mD5K3nC3n7S/N2nA==' >> ~/.ssh/id_rsa
    - echo '-----END RSA PRIVATE KEY-----' >> ~/.ssh/id_rsa
    - chmod 600 ~/.ssh/id_rsa
    - ssh-keyscan -H $DEPLOY_SERVER >> ~/.ssh/known_hosts
  script:
    - echo "=========================================="
    - echo "开始部署到 FAT 环境"
    - echo "目标服务器 ${DEPLOY_SERVER}"
    - echo "部署目录 ${DEPLOY_DIR}"
    - echo "Spring Profile ${SPRING_PROFILE}"
    - echo "=========================================="
    - scp -i ~/.ssh/id_rsa deploy.sh ${DEPLOY_USER}@${DEPLOY_SERVER}:${DEPLOY_DIR}/
    - ssh -i ~/.ssh/id_rsa ${DEPLOY_USER}@${DEPLOY_SERVER} "cd ${DEPLOY_DIR} && chmod +x deploy.sh && bash deploy.sh ${IMAGE_NAME}:${CI_PIPELINE_IID} ${HARBOR_URL} search Search123 ${SPRING_PROFILE}"
    - echo "=========================================="
    - echo "部署完成"
    - echo "访问地址 http://${DEPLOY_SERVER}:${CONTAINER_PORT}"
    - echo "API 文档 http://${DEPLOY_SERVER}:${CONTAINER_PORT}/doc.html"
    - echo "=========================================="
  tags:
    - shell
  only:
    - master
  when: on_success

# ============================================
# 阶段 3: 清理旧镜像
# ============================================
cleanup-old-images:
  stage: cleanup
  image: alpine:latest
  variables:
    GIT_STRATEGY: none
  before_script:
    - sed -i 's/dl-cdn.alpinelinux.org/mirrors.aliyun.com/g' /etc/apk/repositories
    - apk add --no-cache openssh-client
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - |
      cat > ~/.ssh/id_rsa << 'EOFKEY'
      -----BEGIN RSA PRIVATE KEY-----
      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
      -----END RSA PRIVATE KEY-----
      EOFKEY
    - chmod 600 ~/.ssh/id_rsa
    - ssh-keyscan -H $DEPLOY_SERVER >> ~/.ssh/known_hosts
  script:
    - echo "清理服务器上的旧镜像..."
    - |
      ssh -i ~/.ssh/id_rsa ${DEPLOY_USER}@${DEPLOY_SERVER} << 'EOF'
        docker images 192.168.152.56/sysadmin-2025/iplatform-server \
          --format "{{.ID}} {{.CreatedAt}}" | \
          sort -rk2 | tail -n +6 | awk '{print $1}' | \
          xargs -r docker rmi -f || true
        echo "旧镜像清理完成（保留最近 5 个版本）"
      EOF
  dependencies:
    - deploy-to-fat
  tags:
    - shell
  only:
    - master
  when: on_success
  allow_failure: true

notify-on-failure:
  stage: .post
  image: alpine:latest
  variables:
    GIT_STRATEGY: none
  script:
    - echo "Pipeline failed"
    - echo "Commit ${CI_COMMIT_SHORT_SHA}"
    - echo "Branch ${CI_COMMIT_BRANCH}"
    - echo "Build number ${CI_PIPELINE_IID}"
  when: on_failure
  only:
    - master
